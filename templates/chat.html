<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Chat</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>
<div id="toast-container" class="toast-container"></div>

<div class="app-container">
    <aside class="sidebar">
        <div class="header">
            <div class="my-profile" onclick="openProfileModal()">
                <div id="my-avatar-small" class="avatar"></div>
                <span id="my-name">...</span>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="showCreateGroup()" class="small-btn" title="–°—Ç–≤–æ—Ä–∏—Ç–∏ –≥—Ä—É–ø—É">+</button>
                <button onclick="logout()" class="small-btn" title="–í–∏–π—Ç–∏">‚ûî</button>
            </div>
        </div>
        <div class="tabs">
            <button id="tab-groups" class="active" onclick="switchTab('groups')">–ß–∞—Ç–∏</button>
            <button id="tab-users" onclick="switchTab('users')">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</button>
        </div>
        <div id="list-container" class="list-container"></div>
    </aside>

    <main class="chat-main">
        <div class="chat-header" id="chat-header">
            <div style="display:flex; align-items:center;">
                <div id="current-room-avatar" class="avatar" style="margin-right:15px; display:none;"></div>
                <span id="room-name">–û–±–µ—Ä—ñ—Ç—å —á–∞—Ç</span>
            </div>
            <div style="display:flex; gap:10px;">
                <button id="call-btn" class="icon-btn" style="display:none;" onclick="startVideoCall()"
                        title="–í—ñ–¥–µ–æ–¥–∑–≤—ñ–Ω–æ–∫">üìπ
                </button>
                <button id="group-settings-btn" class="icon-btn" style="display:none;" onclick="openGroupSettings()"
                        title="–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è">‚öôÔ∏è
                </button>
                <button id="delete-chat-btn" class="icon-btn" style="display:none; color:var(--danger-color);"
                        onclick="openDeleteChatModal()" title="–í–∏–¥–∞–ª–∏—Ç–∏ —á–∞—Ç">üóë
                </button>
            </div>
        </div>
        <div id="messages-area" class="messages-area"></div>

        <div id="file-preview"
             style="display:none; padding:15px; background:white; border-top:1px solid var(--border-color); font-size:14px; margin: 0 2rem; border-radius: 0.75rem;">
            <span id="file-name" style="font-weight:bold;"></span>
            <input type="text" id="file-caption" placeholder="–ü—ñ–¥–ø–∏—Å –¥–æ —Ñ–∞–π–ª—É"
                   style="width:100%; margin-top:10px; padding:10px; border:1px solid var(--border-color); border-radius:0.5rem;">
            <button onclick="cancelFile()"
                    style="margin-top:10px; padding:5px 10px; cursor:pointer; color:var(--danger-color); background:none; border:none; font-weight:bold;">
                –°–∫–∞—Å—É–≤–∞—Ç–∏
            </button>
        </div>

        <div id="emoji-picker" class="emoji-picker" style="display:none;"></div>

        <div class="input-area">
            <button onclick="document.getElementById('file-input').click()" class="icon-btn">üìé</button>
            <button onclick="toggleEmoji()" class="icon-btn">üòä</button>
            <input type="file" id="file-input" hidden onchange="handleFileSelect(this)">
            <input type="text" id="msg-input" placeholder="–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è...">
            <button onclick="startVideoMessage()" id="video-msg-btn" class="icon-btn" title="–í—ñ–¥–µ–æ–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è">üì∑
            </button>
            <button onclick="startVoice()" id="voice-btn" class="icon-btn">üé§</button>
            <button onclick="sendMessage()" id="send-btn" class="icon-btn" style="color:var(--primary-color)">‚û§</button>
        </div>
    </main>
</div>

<div id="group-modal" class="modal">
    <div class="modal-content">
        <h3>–°—Ç–≤–æ—Ä–∏—Ç–∏ –≥—Ä—É–ø—É</h3>
        <input id="new-group-name" placeholder="–ù–∞–∑–≤–∞ –≥—Ä—É–ø–∏">
        <div id="user-select-list" class="user-select-list"></div>
        <div class="modal-actions">
            <button onclick="createGroup()" class="btn-primary">–°—Ç–≤–æ—Ä–∏—Ç–∏</button>
            <button onclick="closeModal('group-modal')" class="btn-secondary">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </div>
    </div>
</div>

<div id="profile-modal" class="modal">
    <div class="modal-content">
        <h3>–ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å</h3>
        <div class="profile-preview">
            <div id="profile-avatar-big" class="avatar-big"></div>
        </div>

        <div style="margin-bottom:1rem; text-align:center; font-size:0.9rem; color:var(--text-secondary);">
            <p id="my-profile-age"></p>
        </div>

        <div id="profile-gallery" class="avatar-gallery"></div>

        <div style="margin-top:1.5rem; text-align:center;">
            <label for="avatar-input" style="cursor:pointer; color:var(--primary-color); font-weight:600;">+ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏
                –Ω–æ–≤–µ —Ñ–æ—Ç–æ</label>
            <input type="file" id="avatar-input" accept="image/*" style="display:none;" onchange="handleAvatarUpload()">
        </div>

        <label style="display:block; margin-top:1rem; font-size:0.9rem;">–†–µ–∞–ª—å–Ω–µ —ñ–º'—è:</label>
        <input type="text" id="profile-realname" placeholder="–Ü–º'—è">

        <div style="display:flex; gap:10px;">
            <div style="flex:1;">
                <label style="display:block; font-size:0.9rem;">–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è:</label>
                <input type="date" id="profile-birthdate">
            </div>
            <div style="flex:1;">
                <label style="display:block; font-size:0.9rem;">–°—Ç–∞—Ç—å:</label>
                <select id="profile-gender">
                    <option value="male">–ß–æ–ª–æ–≤—ñ–∫</option>
                    <option value="female">–ñ—ñ–Ω–∫–∞</option>
                </select>
            </div>
        </div>

        <label style="display:block; font-size:0.9rem;">–ü—Ä–æ —Å–µ–±–µ:</label>
        <textarea id="profile-bio" class="profile-bio" rows="3" placeholder="–†–æ–∑–∫–∞–∂—ñ—Ç—å –ø—Ä–æ —Å–µ–±–µ..."></textarea>

        <div class="modal-actions">
            <button onclick="saveProfile()" class="btn-primary">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            <button onclick="closeModal('profile-modal')" class="btn-secondary">–ó–∞–∫—Ä–∏—Ç–∏</button>
        </div>
    </div>
</div>

<div id="user-info-modal" class="modal">
    <div class="modal-content">
        <h3 id="user-info-name">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</h3>
        <div class="profile-preview">
            <div id="user-info-avatar-big" class="avatar-big"></div>
        </div>

        <div style="text-align:center; color:var(--text-secondary); font-size:0.9rem; margin-bottom:10px;">
            <p id="user-info-realname"></p>
            <p id="user-info-birth"></p>
            <p id="user-info-age"></p>
        </div>

        <p id="user-info-bio"
           style="text-align:center; font-style:italic; margin:1rem 0; color:var(--text-primary);"></p>

        <div id="user-info-gallery" class="avatar-gallery"></div>

        <div class="modal-actions" style="flex-direction:column;">
            <button id="start-chat-btn" class="btn-primary">–ù–∞–ø–∏—Å–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</button>
            <button onclick="closeModal('user-info-modal')" class="btn-secondary">–ó–∞–∫—Ä–∏—Ç–∏</button>
        </div>
    </div>
</div>

<div id="crop-modal" class="modal">
    <div class="modal-content" style="width:600px; max-width:95%;">
        <h3>–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ñ–æ—Ç–æ</h3>
        <div class="crop-container">
            <img id="crop-image" style="max-width:100%;">
        </div>
        <div class="modal-actions">
            <button id="crop-save-btn" class="btn-primary">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            <button id="crop-cancel-btn" class="btn-secondary">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </div>
    </div>
</div>

<div id="video-modal" class="modal video-modal">
    <div class="modal-content">
        <h3>–í—ñ–¥–µ–æ–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü—ñ—è</h3>
        <div id="video-grid" class="video-grid"></div>

        <div style="display:flex; justify-content:center; gap:1rem; margin-top:1rem;">
            <button id="toggle-mic-btn" onclick="toggleAudio()" class="btn-primary" style="width:auto;">–ú—ñ–∫—Ä–æ—Ñ–æ–Ω
            </button>
            <button id="toggle-cam-btn" onclick="toggleVideo()" class="btn-primary" style="width:auto;">–ö–∞–º–µ—Ä–∞</button>
            <button onclick="toggleScreenShare()" class="btn-secondary" style="width:auto;">–ï–∫—Ä–∞–Ω</button>
            <button onclick="closeVideoCall()" class="btn-primary" style="background:var(--danger-color); width:auto;">
                –ó–∞–≤–µ—Ä—à–∏—Ç–∏
            </button>
        </div>
    </div>
</div>

<div id="group-settings-modal" class="modal">
    <div class="modal-content" style="width: 500px;">
        <h3>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≥—Ä—É–ø–∏</h3>

        <div class="tabs" style="margin-bottom:1rem; padding:0;">
            <button onclick="showGroupTab('info')" class="active">–Ü–Ω—Ñ–æ</button>
            <button onclick="showGroupTab('logs')" id="logs-tab-btn">–ñ—É—Ä–Ω–∞–ª</button>
        </div>

        <div id="group-tab-info">
            <div class="profile-preview">
                <div id="group-settings-avatar" class="avatar-big"></div>
            </div>
            <input type="text" id="group-settings-name" placeholder="–ù–∞–∑–≤–∞ –≥—Ä—É–ø–∏">

            <div style="text-align:center; margin-bottom:1.5rem;">
                <label for="group-avatar-input" style="cursor:pointer; color:var(--primary-color); font-weight:600;">–ó–º—ñ–Ω–∏—Ç–∏
                    —Ñ–æ—Ç–æ –≥—Ä—É–ø–∏</label>
                <input type="file" id="group-avatar-input" accept="image/*" style="display:none;"
                       onchange="handleGroupAvatarUpload()">
            </div>

            <button id="save-group-btn" onclick="updateGroupInfo()" class="btn-primary" style="margin-bottom:2rem;">
                –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏
            </button>

            <h4 style="margin-bottom:1rem; color:var(--text-primary);">–£—á–∞—Å–Ω–∏–∫–∏</h4>
            <div id="group-participants-list" class="user-select-list" style="max-height:200px;"></div>

            <div style="display:flex; gap:10px; margin-top:1rem;">
                <select id="new-participant-select" style="flex:1; padding:0.875rem;"></select>
                <button id="add-participant-btn" onclick="addParticipant()" class="btn-secondary" style="width:auto;">
                    +
                </button>
            </div>

            <button id="delete-group-btn" onclick="deleteGroup()" class="btn-primary"
                    style="background:var(--danger-color); margin-top:2rem;">–í–∏–¥–∞–ª–∏—Ç–∏ –≥—Ä—É–ø—É
            </button>
            <button id="leave-group-btn" onclick="leaveGroup()" class="btn-primary"
                    style="background:var(--danger-color); margin-top:2rem; display:none;">–ü–æ–∫–∏–Ω—É—Ç–∏ –≥—Ä—É–ø—É
            </button>

            <p id="group-info-meta"
               style="margin-top:1rem; font-size:0.8rem; color:var(--text-secondary); text-align:center;"></p>
        </div>

        <div id="group-tab-logs" style="display:none;">
            <div id="group-logs" class="user-select-list" style="max-height:400px;"></div>
        </div>

        <div class="modal-actions">
            <button onclick="closeModal('group-settings-modal')" class="btn-secondary">–ó–∞–∫—Ä–∏—Ç–∏</button>
        </div>
    </div>
</div>

<div id="delete-chat-modal" class="modal">
    <div class="modal-content" style="width: 400px;">
        <h3>–í–∏–¥–∞–ª–µ–Ω–Ω—è —á–∞—Ç—É</h3>
        <div style="margin-bottom:2rem;">
            <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                <input type="checkbox" id="delete-mutual-checkbox" style="width:20px; height:20px;">
                <span style="font-size:1rem;">–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–∞–∫–æ–∂ –¥–ª—è —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫–∞</span>
            </label>
        </div>
        <div class="modal-actions">
            <button onclick="confirmDeleteChat()" class="btn-primary" style="background:var(--danger-color);">–í–∏–¥–∞–ª–∏—Ç–∏
            </button>
            <button onclick="closeModal('delete-chat-modal')" class="btn-secondary">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </div>
    </div>
</div>

<script type="module" src="/static/js/main.js"></script>
</body>
</html>